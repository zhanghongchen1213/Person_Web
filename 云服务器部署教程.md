# 个人博客网站云服务器部署教程

本文档详细介绍如何将个人博客网站部署到云服务器上，涵盖从服务器选购到域名配置的完整流程。本教程适用于主流云服务商（阿里云、腾讯云、华为云等）的 Linux 服务器。

---

## 目录

1. [服务器选购与准备](#1-服务器选购与准备)
2. [服务器环境配置](#2-服务器环境配置)
3. [数据库安装与配置](#3-数据库安装与配置)
4. [项目部署](#4-项目部署)
5. [Nginx 反向代理配置](#5-nginx-反向代理配置)
6. [SSL 证书配置](#6-ssl-证书配置)
7. [域名解析配置](#7-域名解析配置)
8. [进程管理与自动重启](#8-进程管理与自动重启)
9. [常见问题排查](#9-常见问题排查)

---

## 1. 服务器选购与准备

### 1.1 服务器配置推荐

对于个人博客网站，以下配置足以满足日常访问需求：

| 配置项 | 最低配置 | 推荐配置 |
|--------|----------|----------|
| CPU | 1 核 | 2 核 |
| 内存 | 1 GB | 2 GB |
| 系统盘 | 40 GB SSD | 50 GB SSD |
| 带宽 | 1 Mbps | 3-5 Mbps |
| 操作系统 | Ubuntu 20.04/22.04 LTS | Ubuntu 22.04 LTS |

### 1.2 安全组配置

在云服务商控制台配置安全组，开放以下端口：

| 端口 | 协议 | 用途 |
|------|------|------|
| 22 | TCP | SSH 远程连接 |
| 80 | TCP | HTTP 访问 |
| 443 | TCP | HTTPS 访问 |
| 3306 | TCP | MySQL（仅限内网或特定 IP） |

### 1.3 连接服务器

使用 SSH 连接到服务器：

```bash
ssh root@your_server_ip
```

首次登录建议修改 root 密码并创建普通用户：

```bash
# 修改 root 密码
passwd

# 创建新用户
adduser deploy
usermod -aG sudo deploy

# 切换到新用户
su - deploy
```

---

## 2. 服务器环境配置

### 2.1 更新系统

```bash
sudo apt update && sudo apt upgrade -y
```

### 2.2 安装 Node.js

推荐使用 Node.js 20.x LTS 版本：

```bash
# 安装 NodeSource 仓库
curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -

# 安装 Node.js
sudo apt install -y nodejs

# 验证安装
node -v
npm -v
```

### 2.3 安装 pnpm

```bash
# 全局安装 pnpm
sudo npm install -g pnpm

# 验证安装
pnpm -v
```

### 2.4 安装 Git

```bash
sudo apt install -y git

# 配置 Git（可选）
git config --global user.name "Your Name"
git config --global user.email "your@email.com"
```

### 2.5 安装构建工具

```bash
sudo apt install -y build-essential
```

---

## 3. 数据库安装与配置

### 3.1 安装 MySQL

```bash
# 安装 MySQL Server
sudo apt install -y mysql-server

# 启动 MySQL 服务
sudo systemctl start mysql
sudo systemctl enable mysql

# 运行安全配置脚本
sudo mysql_secure_installation
```

安全配置过程中的建议选项：

- 设置 root 密码：**是**
- 移除匿名用户：**是**
- 禁止 root 远程登录：**是**
- 移除测试数据库：**是**
- 重新加载权限表：**是**

### 3.2 创建数据库和用户

```bash
# 登录 MySQL
sudo mysql -u root -p

# 在 MySQL 命令行中执行：
CREATE DATABASE blog_db CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'blog_user'@'localhost' IDENTIFIED BY 'your_strong_password';
GRANT ALL PRIVILEGES ON blog_db.* TO 'blog_user'@'localhost';
FLUSH PRIVILEGES;
EXIT;
```

> **重要提示**：请将 `your_strong_password` 替换为强密码，建议包含大小写字母、数字和特殊字符。

### 3.3 验证数据库连接

```bash
mysql -u blog_user -p blog_db
```

---

## 4. 项目部署

### 4.1 创建项目目录

```bash
sudo mkdir -p /var/www/blog
sudo chown -R $USER:$USER /var/www/blog
cd /var/www/blog
```

### 4.2 上传项目文件

**方式一：使用 Git 克隆（推荐）**

如果项目托管在 Git 仓库：

```bash
git clone https://github.com/your-username/personal-blog.git .
```

**方式二：使用 SCP 上传**

从本地上传项目文件：

```bash
# 在本地执行
scp -r ./personal-blog/* deploy@your_server_ip:/var/www/blog/
```

**方式三：使用 SFTP 工具**

使用 FileZilla、WinSCP 等工具上传文件。

### 4.3 安装依赖

```bash
cd /var/www/blog
pnpm install
```

### 4.4 配置环境变量

创建 `.env` 文件：

```bash
nano .env
```

添加以下配置（根据实际情况修改）：

```env
# 数据库配置
DATABASE_URL="mysql://blog_user:your_strong_password@localhost:3306/blog_db"

# JWT 密钥（使用随机字符串）
JWT_SECRET="your_random_jwt_secret_key_here"

# 应用配置
NODE_ENV=production
PORT=3000

# OAuth 配置（如果使用 Manus OAuth）
VITE_APP_ID="your_app_id"
OAUTH_SERVER_URL="https://api.manus.im"
VITE_OAUTH_PORTAL_URL="https://manus.im/login"

# 网站所有者信息
OWNER_OPEN_ID="your_owner_open_id"
OWNER_NAME="Your Name"
```

> **安全提示**：生成 JWT_SECRET 的方法：
> ```bash
> openssl rand -base64 32
> ```

### 4.5 初始化数据库

```bash
pnpm db:push
```

### 4.6 构建项目

```bash
pnpm build
```

### 4.7 测试运行

```bash
pnpm start
```

访问 `http://your_server_ip:3000` 验证项目是否正常运行。

---

## 5. Nginx 反向代理配置

### 5.1 安装 Nginx

```bash
sudo apt install -y nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

### 5.2 创建 Nginx 配置文件

```bash
sudo nano /etc/nginx/sites-available/blog
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;

    # 日志配置
    access_log /var/log/nginx/blog_access.log;
    error_log /var/log/nginx/blog_error.log;

    # Gzip 压缩
    gzip on;
    gzip_vary on;
    gzip_min_length 1024;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;

    # 静态文件缓存
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # API 和页面请求
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 86400;
    }
}
```

### 5.3 启用配置

```bash
# 创建软链接
sudo ln -s /etc/nginx/sites-available/blog /etc/nginx/sites-enabled/

# 删除默认配置（可选）
sudo rm /etc/nginx/sites-enabled/default

# 测试配置
sudo nginx -t

# 重新加载 Nginx
sudo systemctl reload nginx
```

---

## 6. SSL 证书配置

### 6.1 安装 Certbot

```bash
sudo apt install -y certbot python3-certbot-nginx
```

### 6.2 申请 SSL 证书

```bash
sudo certbot --nginx -d your_domain.com -d www.your_domain.com
```

按照提示完成验证，Certbot 会自动修改 Nginx 配置并配置 HTTPS。

### 6.3 自动续期

Certbot 会自动设置定时任务续期证书。验证自动续期：

```bash
sudo certbot renew --dry-run
```

### 6.4 手动配置 SSL（可选）

如果使用其他证书提供商，手动配置 Nginx：

```nginx
server {
    listen 443 ssl http2;
    server_name your_domain.com www.your_domain.com;

    ssl_certificate /etc/ssl/certs/your_domain.crt;
    ssl_certificate_key /etc/ssl/private/your_domain.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256;
    ssl_prefer_server_ciphers off;

    # ... 其他配置同上
}

# HTTP 重定向到 HTTPS
server {
    listen 80;
    server_name your_domain.com www.your_domain.com;
    return 301 https://$server_name$request_uri;
}
```

---

## 7. 域名解析配置

### 7.1 添加 DNS 记录

在域名服务商控制台添加以下 DNS 记录：

| 记录类型 | 主机记录 | 记录值 | TTL |
|----------|----------|--------|-----|
| A | @ | your_server_ip | 600 |
| A | www | your_server_ip | 600 |

### 7.2 验证解析

```bash
# 验证 DNS 解析
nslookup your_domain.com
dig your_domain.com
```

DNS 解析生效通常需要几分钟到 48 小时不等。

---

## 8. 进程管理与自动重启

### 8.1 安装 PM2

```bash
sudo npm install -g pm2
```

### 8.2 使用 PM2 启动应用

```bash
cd /var/www/blog
pm2 start dist/index.js --name blog
```

### 8.3 PM2 常用命令

```bash
# 查看应用状态
pm2 status

# 查看日志
pm2 logs blog

# 重启应用
pm2 restart blog

# 停止应用
pm2 stop blog

# 删除应用
pm2 delete blog
```

### 8.4 设置开机自启

```bash
# 生成启动脚本
pm2 startup

# 保存当前进程列表
pm2 save
```

### 8.5 创建 PM2 配置文件（可选）

创建 `ecosystem.config.cjs` 文件：

```javascript
module.exports = {
  apps: [{
    name: 'blog',
    script: 'dist/index.js',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '500M',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    }
  }]
};
```

使用配置文件启动：

```bash
pm2 start ecosystem.config.cjs
```

---

## 9. 常见问题排查

### 9.1 应用无法启动

**检查端口占用：**

```bash
sudo lsof -i :3000
```

**检查日志：**

```bash
pm2 logs blog --lines 100
```

**检查环境变量：**

```bash
cat /var/www/blog/.env
```

### 9.2 数据库连接失败

**检查 MySQL 服务状态：**

```bash
sudo systemctl status mysql
```

**检查数据库连接：**

```bash
mysql -u blog_user -p blog_db -e "SELECT 1"
```

**检查 DATABASE_URL 格式：**

确保格式正确：`mysql://user:password@host:port/database`

### 9.3 Nginx 502 错误

**检查应用是否运行：**

```bash
pm2 status
curl http://127.0.0.1:3000
```

**检查 Nginx 错误日志：**

```bash
sudo tail -f /var/log/nginx/blog_error.log
```

### 9.4 SSL 证书问题

**检查证书有效期：**

```bash
sudo certbot certificates
```

**手动续期：**

```bash
sudo certbot renew
```

### 9.5 权限问题

**修复项目目录权限：**

```bash
sudo chown -R $USER:$USER /var/www/blog
chmod -R 755 /var/www/blog
```

---

## 附录：部署检查清单

部署完成后，请逐项检查：

- [ ] 服务器安全组已配置正确端口
- [ ] Node.js 和 pnpm 已正确安装
- [ ] MySQL 已安装并创建数据库和用户
- [ ] 项目文件已上传到服务器
- [ ] 环境变量已正确配置
- [ ] 数据库迁移已执行
- [ ] 项目已成功构建
- [ ] PM2 已配置并启动应用
- [ ] Nginx 反向代理已配置
- [ ] SSL 证书已申请并配置
- [ ] 域名已正确解析
- [ ] 网站可通过 HTTPS 正常访问

---

## 更新与维护

### 更新项目

```bash
cd /var/www/blog

# 拉取最新代码（如果使用 Git）
git pull

# 安装依赖
pnpm install

# 执行数据库迁移
pnpm db:push

# 重新构建
pnpm build

# 重启应用
pm2 restart blog
```

### 备份数据库

```bash
# 创建备份
mysqldump -u blog_user -p blog_db > backup_$(date +%Y%m%d).sql

# 恢复备份
mysql -u blog_user -p blog_db < backup_20240101.sql
```

### 监控服务器

```bash
# 查看系统资源
htop

# 查看磁盘使用
df -h

# 查看内存使用
free -m
```

---

**文档版本**：1.0  
**最后更新**：2026年1月

如有问题，请参考项目 README 或提交 Issue。
